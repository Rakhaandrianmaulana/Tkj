<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alat Deteksi Gerakan & Penggaris Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Mencegah zoom saat disentuh */
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4 / 3;
            margin: auto;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #video {
            object-fit: cover;
            transform: scaleX(-1); /* Cermin untuk kamera depan */
        }
        #canvas {
            z-index: 10;
        }
        .dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: rgba(255, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-6 space-y-6">
        <h1 class="text-3xl font-bold text-center text-white mb-2">Multi-Alat Sensor</h1>
        <p class="text-center text-gray-400 mb-6">Gunakan sensor perangkat Anda untuk mengukur gerakan dan jarak.</p>

        <!-- Navigasi Tab -->
        <div class="flex border-b border-gray-700">
            <button id="tab-pedometer" class="tab-button flex-1 py-3 px-4 text-center font-semibold text-gray-300 rounded-t-lg transition duration-300 hover:bg-gray-700 active">Pedometer</button>
            <button id="tab-ruler" class="tab-button flex-1 py-3 px-4 text-center font-semibold text-gray-300 rounded-t-lg transition duration-300 hover:bg-gray-700">Penggaris Digital</button>
        </div>

        <!-- Konten Pedometer -->
        <div id="content-pedometer" class="space-y-6">
            <div class="text-center p-6 bg-gray-700 rounded-lg">
                <h2 class="text-lg font-semibold text-indigo-400 mb-2">Jumlah Langkah</h2>
                <p id="step-count" class="text-6xl font-bold text-white">0</p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                 <div class="text-center p-4 bg-gray-700 rounded-lg">
                    <h2 class="text-md font-semibold text-indigo-400 mb-1">Kecepatan</h2>
                    <p id="speed" class="text-2xl font-bold text-white">0.00 <span class="text-sm">km/j</span></p>
                </div>
                 <div class="text-center p-4 bg-gray-700 rounded-lg">
                    <h2 class="text-md font-semibold text-indigo-400 mb-1">Waktu</h2>
                    <p id="timer" class="text-2xl font-bold text-white">0s</p>
                </div>
            </div>
            <div class="flex justify-center">
                <button id="pedometer-toggle" class="w-32 py-3 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-300">
                    Mulai
                </button>
            </div>
             <div id="pedometer-permission-alert" class="hidden text-center p-4 bg-yellow-900/50 text-yellow-300 border border-yellow-700 rounded-lg">
                Untuk memulai, mohon berikan izin akses ke sensor Gerak & Orientasi saat diminta oleh browser Anda.
            </div>
        </div>

        <!-- Konten Penggaris Digital -->
        <div id="content-ruler" class="hidden space-y-4">
            <div id="video-container" class="bg-gray-900">
                <video id="video" playsinline></video>
                <canvas id="canvas"></canvas>
            </div>
            <div class="text-center">
                <p id="ruler-status" class="text-gray-400 h-6">Mulai kamera untuk mengukur</p>
                <p id="ruler-result" class="text-2xl font-bold text-white mt-2">-</p>
            </div>
             <div class="grid grid-cols-2 gap-4">
                 <button id="camera-toggle" class="w-full py-3 px-4 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-400 focus:ring-opacity-75 transition duration-300">
                    Mulai Kamera
                </button>
                <button id="mark-point" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                    Tandai Titik
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Logika Navigasi Tab
            const tabPedometer = document.getElementById('tab-pedometer');
            const tabRuler = document.getElementById('tab-ruler');
            const contentPedometer = document.getElementById('content-pedometer');
            const contentRuler = document.getElementById('content-ruler');

            function switchTab(activeTab) {
                if (activeTab === 'pedometer') {
                    tabPedometer.classList.add('active');
                    tabRuler.classList.remove('active');
                    contentPedometer.style.display = 'block';
                    contentRuler.style.display = 'none';
                    stopCamera(); // Matikan kamera saat beralih tab
                } else {
                    tabRuler.classList.add('active');
                    tabPedometer.classList.remove('active');
                    contentRuler.style.display = 'block';
                    contentPedometer.style.display = 'none';
                    stopPedometer(); // Matikan pedometer saat beralih tab
                }
            }

            tabPedometer.addEventListener('click', () => switchTab('pedometer'));
            tabRuler.addEventListener('click', () => switchTab('ruler'));

            // --- Logika Pedometer ---
            const pedometerToggle = document.getElementById('pedometer-toggle');
            const stepCountEl = document.getElementById('step-count');
            const speedEl = document.getElementById('speed');
            const timerEl = document.getElementById('timer');
            const permissionAlert = document.getElementById('pedometer-permission-alert');

            let isPedometerActive = false;
            let stepCount = 0;
            let lastMagnitude = 0;
            let stepThreshold = 11.5; // Sesuaikan ambang batas ini jika perlu
            let stepCooldown = 500; // 500ms cooldown antar langkah
            let lastStepTime = 0;
            let startTime = 0;
            let timerInterval;
            
            // Faktor untuk konversi
            const averageStepLengthMeters = 0.762; // Rata-rata panjang langkah dalam meter

            function startPedometer() {
                // Meminta izin akses sensor
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('devicemotion', handleMotion);
                                isPedometerActive = true;
                                pedometerToggle.textContent = 'Berhenti';
                                pedometerToggle.classList.replace('bg-indigo-600', 'bg-red-600');
                                pedometerToggle.classList.replace('hover:bg-indigo-700', 'hover:bg-red-700');
                                permissionAlert.classList.add('hidden');
                                resetPedometerState();
                                startTimer();
                            } else {
                                alert('Izin akses sensor gerak ditolak. Pedometer tidak dapat berfungsi.');
                            }
                        })
                        .catch(console.error);
                } else {
                     // Untuk browser yang tidak memerlukan izin eksplisit (misalnya Android Chrome)
                    window.addEventListener('devicemotion', handleMotion);
                    isPedometerActive = true;
                    pedometerToggle.textContent = 'Berhenti';
                    pedometerToggle.classList.replace('bg-indigo-600', 'bg-red-600');
                    pedometerToggle.classList.replace('hover:bg-indigo-700', 'hover:bg-red-700');
                    resetPedometerState();
                    startTimer();
                }
            }

            function stopPedometer() {
                window.removeEventListener('devicemotion', handleMotion);
                isPedometerActive = false;
                pedometerToggle.textContent = 'Mulai';
                pedometerToggle.classList.replace('bg-red-600', 'bg-indigo-600');
                pedometerToggle.classList.replace('hover:bg-red-700', 'hover:bg-indigo-700');
                stopTimer();
            }

            function resetPedometerState() {
                stepCount = 0;
                lastMagnitude = 0;
                lastStepTime = 0;
                startTime = Date.now();
                stepCountEl.textContent = '0';
                speedEl.innerHTML = '0.00 <span class="text-sm">km/j</span>';
                timerEl.textContent = '0s';
            }
            
            function startTimer() {
                timerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    timerEl.textContent = `${elapsedSeconds}s`;
                    updateSpeed(elapsedSeconds);
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function updateSpeed(elapsedSeconds) {
                if (elapsedSeconds > 0) {
                    const distanceMeters = stepCount * averageStepLengthMeters;
                    const speedMps = distanceMeters / elapsedSeconds; // meter per detik
                    const speedKph = speedMps * 3.6; // kilometer per jam
                    speedEl.innerHTML = `${speedKph.toFixed(2)} <span class="text-sm">km/j</span>`;
                }
            }

            const handleMotion = (event) => {
                if (!isPedometerActive) return;
                
                const { x, y, z } = event.accelerationIncludingGravity;
                const magnitude = Math.sqrt(x * x + y * y + z * z);
                const magnitudeDelta = magnitude - lastMagnitude;
                lastMagnitude = magnitude;

                const now = Date.now();
                if (magnitudeDelta > 1.2 && now - lastStepTime > stepCooldown) { // Deteksi puncak gerakan
                    if (magnitude > stepThreshold) {
                         stepCount++;
                         stepCountEl.textContent = stepCount;
                         lastStepTime = now;
                    }
                }
            };
            
            pedometerToggle.addEventListener('click', () => {
                if (isPedometerActive) {
                    stopPedometer();
                } else {
                    // Tampilkan notifikasi izin untuk iOS
                    if (typeof DeviceMotionEvent.requestPermission === 'function') {
                       permissionAlert.classList.remove('hidden');
                    }
                    startPedometer();
                }
            });

            // --- Logika Penggaris Digital ---
            const cameraToggle = document.getElementById('camera-toggle');
            const markPointBtn = document.getElementById('mark-point');
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const rulerStatus = document.getElementById('ruler-status');
            const rulerResult = document.getElementById('ruler-result');
            const ctx = canvas.getContext('2d');

            let isCameraActive = false;
            let stream;
            let points = [];
            let isMeasuring = false;

            function startCamera() {
                const constraints = {
                    video: {
                        facingMode: 'environment', // Mengutamakan kamera belakang
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(s => {
                        stream = s;
                        video.srcObject = stream;
                        video.play();
                        isCameraActive = true;
                        cameraToggle.textContent = 'Hentikan Kamera';
                        cameraToggle.classList.replace('bg-teal-600', 'bg-red-600');
                        cameraToggle.classList.replace('hover:bg-teal-700', 'hover:bg-red-700');
                        markPointBtn.disabled = false;
                        rulerStatus.textContent = 'Kamera aktif. Tekan "Tandai Titik".';
                        
                        // Sesuaikan ukuran canvas dengan video
                        video.onloadedmetadata = () => {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        };
                    })
                    .catch(err => {
                        console.error("Error accessing camera: ", err);
                        rulerStatus.textContent = 'Gagal mengakses kamera.';
                        alert("Tidak bisa mengakses kamera. Pastikan Anda memberikan izin dan tidak ada aplikasi lain yang menggunakannya.");
                    });
            }

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                isCameraActive = false;
                video.srcObject = null;
                cameraToggle.textContent = 'Mulai Kamera';
                cameraToggle.classList.replace('bg-red-600', 'bg-teal-600');
                cameraToggle.classList.replace('hover:bg-red-700', 'hover:bg-teal-700');
                markPointBtn.disabled = true;
                markPointBtn.textContent = 'Tandai Titik';
                rulerStatus.textContent = 'Mulai kamera untuk mengukur.';
                rulerResult.textContent = '-';
                points = [];
                isMeasuring = false;
                clearCanvas();
            }

            function clearCanvas() {
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            function draw() {
                clearCanvas();
                if (points.length > 0) {
                    // Gambar titik pertama
                    ctx.beginPath();
                    ctx.arc(points[0].x, points[0].y, 10, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.8)';
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    if (points.length > 1) {
                         // Gambar titik kedua
                        ctx.beginPath();
                        ctx.arc(points[1].x, points[1].y, 10, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.8)';
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        // Gambar garis
                        ctx.beginPath();
                        ctx.moveTo(points[0].x, points[0].y);
                        ctx.lineTo(points[1].x, points[1].y);
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 4;
                        ctx.stroke();
                        ctx.strokeStyle = 'rgba(79, 70, 229, 1)';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                    }
                }
            }

            function handleMarkPoint() {
                if (!isMeasuring) { // Titik Awal
                    points = []; // Reset titik
                    isMeasuring = true;
                    // Tandai titik di tengah canvas
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    points.push({ x: centerX, y: centerY });
                    
                    markPointBtn.textContent = 'Tandai Titik Akhir';
                    rulerStatus.textContent = 'Arahkan ke titik akhir dan tandai lagi.';
                    rulerResult.textContent = 'Mengukur...';
                    draw();
                } else { // Titik Akhir
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    points.push({ x: centerX, y: centerY });

                    isMeasuring = false;
                    markPointBtn.textContent = 'Ukur Ulang';
                    calculateDistance();
                    draw();
                }
            }

            function calculateDistance() {
                if (points.length < 2) return;
                
                // Ini adalah placeholder. Pengukuran akurat memerlukan kalibrasi atau sensor AR.
                // Untuk demo, kita akan menampilkan jarak dalam "unit" piksel.
                const dx = points[1].x - points[0].x;
                const dy = points[1].y - points[0].y;
                const distanceInPixels = Math.sqrt(dx * dx + dy * dy);
                
                rulerStatus.textContent = 'Pengukuran selesai. Hasil di bawah.';
                rulerResult.textContent = `${distanceInPixels.toFixed(1)} unit`;
                
                // Tambahkan catatan bahwa ini bukan ukuran dunia nyata
                rulerResult.innerHTML += '<p class="text-xs text-gray-500 mt-1">(Jarak dalam piksel, bukan cm/meter. Memerlukan kalibrasi untuk akurasi.)</p>';
            }

            cameraToggle.addEventListener('click', () => {
                if (isCameraActive) {
                    stopCamera();
                } else {
                    startCamera();
                }
            });

            markPointBtn.addEventListener('click', handleMarkPoint);
        });
    </script>
</body>
</html>
